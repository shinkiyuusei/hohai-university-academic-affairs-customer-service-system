import{_ as me}from"./_plugin-vue_export-helper-DRcqrMy4.js";/* empty css                  *//* empty css                   *//* empty css                 *//* empty css               *//* empty css                    *//* empty css                 *//* empty css                  *//* empty css                */import{d as he,r as u,s as ye,l as m,f as s,c as B,x as P,g as a,m as p,w as l,A as Ee,a9 as Te,k as ke,j as Se,i as Ce,aa as we,n as i,o as c,B as v,Q as J,aP as be,z as n,aQ as Pe,au as Oe,aR as X,ac as xe,aS as De,aH as Ie,aT as Z,aU as Ne,O as A,a8 as L,y as Re,aV as Be,aN as Ae,ag as U}from"./index-CK_LbvG7.js";import{g as Le,a as ee,s as Ue,b as Me,c as $e,r as Ve,d as Ge}from"./knowledge_graph-DlY0pitf.js";const Fe={class:"knowledge-graph-management"},Qe={class:"page-header"},He={class:"page-title"},Ye={class:"statistics-cards"},Ke={class:"stat-content"},je={class:"stat-icon node-icon"},We={class:"stat-info"},qe={class:"stat-value"},ze={class:"stat-content"},Je={class:"stat-icon relation-icon"},Xe={class:"stat-info"},Ze={class:"stat-value"},et={class:"stat-content"},tt={class:"stat-icon type-icon"},st={class:"stat-info"},at={class:"stat-value"},lt={class:"stat-content"},ot={class:"stat-icon entity-icon"},nt={class:"stat-info"},rt={class:"stat-value"},it={class:"action-bar"},ut={class:"left-actions"},ct={class:"right-actions"},dt={class:"progress-header"},_t={class:"progress-title"},pt={class:"progress-text"},vt={class:"progress-info"},ft={class:"info-text"},gt={key:0,class:"info-detail"},mt={class:"card-header"},ht={class:"entity-list"},yt=["onClick"],Et={class:"entity-header"},Tt={class:"entity-name"},kt={key:0,class:"entity-props"},St={class:"card-header"},Ct={class:"node-types"},wt={class:"progress-content"},bt={class:"progress-step"},Pt={key:0,class:"progress-details"},Ot={class:"detail-item"},xt={class:"value"},Dt={class:"detail-item"},It={class:"value"},Nt={key:0,class:"detail-item"},Rt={class:"value"},G="kg_build_task",Bt=he({__name:"KnowledgeGraphManagement",setup(At){const E=u({}),d=u(!1),f=u(!1),h=u(!1),O=u(""),S=u(0),T=u(""),C=u(""),y=u(0),w=u(0),b=u("");let D=null;const x=u(""),k=u([]),te=u(["AcademicPolicy","Course","Student","Teacher","Major","Schedule","Requirement","Procedure","Document","TimePoint"]),se=u(["APPLIES_TO","REQUIRES","BELONGS_TO","TAUGHT_BY","FOLLOWS","MEETS_REQUIREMENT","SCHEDULED_AT","RELATED_TO","DOCUMENTED_IN","PREREQUISITE_OF","EQUIVALENT_TO"]),F=(t,e)=>{const r={task_id:t,task_type:e,start_time:Date.now()};localStorage.setItem(G,JSON.stringify(r))},ae=()=>{const t=localStorage.getItem(G);if(!t)return null;try{return JSON.parse(t)}catch{return null}},I=()=>{localStorage.removeItem(G)},N=async()=>{try{const t=await Le();E.value=t}catch(t){i.error(t.message||"获取统计信息失败")}},Q=async()=>{if(O.value)try{const t=await ee(O.value);if(S.value=t.progress||0,T.value=t.status,C.value=t.current_step||"",y.value=t.total_documents||0,w.value=t.processed_documents||0,b.value=t.current_document||"",t.status==="completed"){H(),I(),h.value=!1,d.value=!1,f.value=!1;const e=t.result;e?i.success({message:`构建完成！处理 ${e.documents_processed} 个文档，提取 ${e.triplets_extracted} 个三元组，创建 ${e.nodes_created} 个节点，${e.relationships_created} 个关系`,duration:5e3}):i.success("构建完成！"),await N()}else t.status==="failed"&&(H(),I(),h.value=!1,d.value=!1,f.value=!1,i.error(t.error||"构建失败"))}catch(t){console.error("查询进度失败:",t)}},M=()=>{Q(),D=setInterval(Q,1e3)},H=()=>{D&&(clearInterval(D),D=null)},le=()=>{U.confirm("此操作将构建所有未构建图谱的文档，不会清空现有图谱数据，是否继续？","增量构建知识图谱",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}).then(async()=>{d.value=!0,f.value=!0;try{const t=await $e();O.value=t.task_id,F(t.task_id,"incremental"),S.value=0,T.value="running",C.value="任务已启动...",y.value=0,w.value=0,b.value="",h.value=!0,M(),i.info("任务已启动，正在后台执行")}catch(t){d.value=!1,f.value=!1,i.error(t.message||"启动增量构建失败")}}).catch(()=>{})},oe=()=>{U.confirm("此操作将清空现有图谱数据并重新构建所有文档的知识图谱，是否继续？","全量重建知识图谱",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{d.value=!0,f.value=!0;try{const t=await Ve();O.value=t.task_id,F(t.task_id,"full"),S.value=0,T.value="running",C.value="任务已启动...",y.value=0,w.value=0,b.value="",h.value=!0,M(),i.info("任务已启动，正在后台执行")}catch(t){d.value=!1,f.value=!1,i.error(t.message||"启动全量重建失败")}}).catch(()=>{})},ne=()=>{h.value=!1},re=()=>{U.confirm("此操作将清空所有图谱数据，并重置所有文档的构建标志。清空后，增量构建将重新处理所有文档。是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{d.value=!0;try{await Ge(),i.success("图谱已清空，所有文档标志已重置"),await N()}catch(t){i.error(t.message||"清空图谱失败")}finally{d.value=!1}}).catch(()=>{})},Y=async()=>{if(!x.value.trim()){i.warning("请输入搜索关键词");return}try{d.value=!0;const t=await Ue({keywords:[x.value.trim()],limit:20});k.value=t||[],k.value.length===0?i.info("未找到相关实体"):i.success(`找到 ${k.value.length} 个相关实体`)}catch(t){i.error(t.message||"搜索失败")}finally{d.value=!1}},ie=()=>{k.value=[],x.value="",i.info("已清空搜索结果")},ue=async t=>{var e,r;try{const g=await Me(t.name,{entity_type:t.type,depth:1});let _="";if(t.properties&&Object.keys(t.properties).length>0){_="<h4>属性信息：</h4><ul>";for(const[$,R]of Object.entries(t.properties))_+=`<li><strong>${$}:</strong> ${R}</li>`;_+="</ul>"}U.alert(`<div style="max-height: 500px; overflow-y: auto;">
        <h3>${t.name}</h3>
        <p><strong>类型:</strong> ${W(t.type)} (${t.type})</p>
        <p><strong>邻居节点数量:</strong> ${((e=g.nodes)==null?void 0:e.length)||0}</p>
        <p><strong>关系数量:</strong> ${((r=g.relationships)==null?void 0:r.length)||0}</p>
        ${_}
        <div style="margin-top: 20px; padding: 12px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
          <p style="margin: 0; color: #1e40af;">
            <strong>💡 提示：</strong>如需查看图形化的节点关系，请前往"知识图谱可视化"页面，在搜索框中输入"${t.name}"进行搜索。
          </p>
        </div>
      </div>`,"实体详情",{dangerouslyUseHTMLString:!0,confirmButtonText:"关闭"})}catch(g){i.error(g.message||"获取实体详情失败")}},ce=t=>({PlantDisease:"danger",Plant:"success",Pathogen:"warning",Symptom:"warning",Prevention:"primary",Location:"info",Season:"danger",Environment:"success",Document:"info",TimePoint:"warning"})[t]||"info",K=t=>{const e=`${t.toLowerCase()}_count`;return E.value[e]||0},j=t=>{const e=`${t.toLowerCase()}_count`;return E.value[e]||0},de={PlantDisease:"植物病害",Plant:"植物",Pathogen:"病原体",Symptom:"症状",Prevention:"防治措施",Location:"地点",Season:"季节",Environment:"环境因素",Document:"文档",TimePoint:"时间点",AcademicPolicy:"教务政策",Course:"课程",Student:"学生",Teacher:"教师",Major:"专业",Schedule:"课表",Requirement:"要求规定",Procedure:"流程"},_e={AFFECTS:"影响",CAUSED_BY:"由...引起",SHOWS_SYMPTOM:"表现症状",OCCURS_IN:"发生于",PREVENTED_BY:"被预防",TREATED_BY:"被治疗",OCCURS_AT:"发生时间",FAVORED_BY:"受...促进",DOCUMENTED_IN:"记录于",LOCATED_IN:"位于",RELATED_TO:"相关",APPLIES_TO:"适用于",REQUIRES:"要求",BELONGS_TO:"属于",TAUGHT_BY:"由...教授",FOLLOWS:"遵循",MEETS_REQUIREMENT:"满足要求",SCHEDULED_AT:"安排在",PREREQUISITE_OF:"先修课程",EQUIVALENT_TO:"等价于"},W=t=>de[t]||t,pe=t=>_e[t]||t,ve=async()=>{const t=ae();if(t)try{const e=await ee(t.task_id);e.status==="running"||e.status==="pending"?(O.value=t.task_id,f.value=!0,S.value=e.progress||0,T.value=e.status,C.value=e.current_step||"正在恢复任务状态...",y.value=e.total_documents||0,w.value=e.processed_documents||0,b.value=e.current_document||"",M(),i.info({message:`检测到正在进行的${t.task_type==="incremental"?"增量构建":"全量重建"}任务，已自动恢复进度显示`,duration:3e3})):I()}catch(e){console.error("恢复任务失败:",e),I()}};return ye(()=>{N(),ve()}),(t,e)=>{const r=Ee,g=Te,_=ke,$=Ce,R=Ne,V=Re,fe=Ae,ge=we;return c(),m("div",Fe,[s("div",Qe,[s("h1",He,[a(r,{class:"title-icon"},{default:l(()=>[a(v(J))]),_:1}),e[3]||(e[3]=p(" 知识图谱管理 ",-1))]),e[4]||(e[4]=s("p",{class:"page-subtitle"}," 管理植物病害知识图谱，同步文档数据到Neo4j图数据库 ",-1))]),s("div",Ye,[a(g,{class:"stat-card"},{default:l(()=>[s("div",Ke,[s("div",je,[a(r,null,{default:l(()=>[a(v(be))]),_:1})]),s("div",We,[e[5]||(e[5]=s("div",{class:"stat-label"},"节点数量",-1)),s("div",qe,n(E.value.nodeCount||0),1)])])]),_:1}),a(g,{class:"stat-card"},{default:l(()=>[s("div",ze,[s("div",Je,[a(r,null,{default:l(()=>[a(v(J))]),_:1})]),s("div",Xe,[e[6]||(e[6]=s("div",{class:"stat-label"},"关系数量",-1)),s("div",Ze,n(E.value.relationshipCount||0),1)])])]),_:1}),a(g,{class:"stat-card"},{default:l(()=>{var o;return[s("div",et,[s("div",tt,[a(r,null,{default:l(()=>[a(v(Pe))]),_:1})]),s("div",st,[e[7]||(e[7]=s("div",{class:"stat-label"},"节点类型",-1)),s("div",at,n(((o=E.value.nodeTypes)==null?void 0:o.length)||0),1)])])]}),_:1}),a(g,{class:"stat-card"},{default:l(()=>{var o;return[s("div",lt,[s("div",ot,[a(r,null,{default:l(()=>[a(v(Oe))]),_:1})]),s("div",nt,[e[8]||(e[8]=s("div",{class:"stat-label"},"关系类型",-1)),s("div",rt,n(((o=E.value.relationshipTypes)==null?void 0:o.length)||0),1)])])]}),_:1})]),s("div",it,[s("div",ut,[a(_,{type:"success",onClick:le,loading:d.value,disabled:f.value},{default:l(()=>[a(r,null,{default:l(()=>[a(v(X))]),_:1}),e[9]||(e[9]=p(" 增量构建图谱 ",-1))]),_:1},8,["loading","disabled"]),a(_,{type:"primary",onClick:oe,loading:d.value,disabled:f.value},{default:l(()=>[a(r,null,{default:l(()=>[a(v(X))]),_:1}),e[10]||(e[10]=p(" 全量重建图谱 ",-1))]),_:1},8,["loading","disabled"]),a(_,{type:"danger",onClick:re,loading:d.value,disabled:f.value},{default:l(()=>[a(r,null,{default:l(()=>[a(v(xe))]),_:1}),e[11]||(e[11]=p(" 清空图谱 ",-1))]),_:1},8,["loading","disabled"]),a(_,{onClick:N,disabled:f.value},{default:l(()=>[a(r,null,{default:l(()=>[a(v(De))]),_:1}),e[12]||(e[12]=p(" 刷新统计 ",-1))]),_:1},8,["disabled"])]),s("div",ct,[a($,{modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=o=>x.value=o),placeholder:"搜索图谱实体",style:{width:"300px"},clearable:"",onKeyup:Se(Y,["enter"])},{append:l(()=>[a(_,{onClick:Y},{default:l(()=>[a(r,null,{default:l(()=>[a(v(Ie))]),_:1})]),_:1})]),_:1},8,["modelValue"])])]),f.value?(c(),B(g,{key:0,class:"progress-card"},{default:l(()=>[s("div",dt,[s("div",_t,[a(r,{class:"rotating-icon"},{default:l(()=>[a(v(Z))]),_:1}),s("span",null,n(T.value==="running"?"正在构建知识图谱":"构建任务进行中"),1)]),a(_,{size:"small",text:"",onClick:e[1]||(e[1]=o=>h.value=!0)},{default:l(()=>[...e[13]||(e[13]=[p(" 查看详情 ",-1)])]),_:1})]),a(R,{percentage:S.value,status:T.value==="failed"?"exception":void 0,"stroke-width":12},{default:l(({percentage:o})=>[s("span",pt,n(o)+"%",1)]),_:1},8,["percentage","status"]),s("div",vt,[s("span",ft,n(C.value),1),y.value>0?(c(),m("span",gt,n(w.value)+" / "+n(y.value)+" 个文档 ",1)):P("",!0)])]),_:1})):P("",!0),k.value.length>0?(c(),B(g,{key:1,class:"search-results"},{header:l(()=>[s("div",mt,[s("span",null,"搜索结果（共 "+n(k.value.length)+" 个实体）",1),a(_,{text:"",onClick:ie},{default:l(()=>[...e[14]||(e[14]=[p("清空并恢复完整视图",-1)])]),_:1})])]),default:l(()=>[s("div",ht,[(c(!0),m(A,null,L(k.value,o=>(c(),m("div",{key:o.id,class:"entity-item",onClick:q=>ue(o)},[s("div",Et,[a(V,{type:ce(o.type)},{default:l(()=>[p(n(o.type),1)]),_:2},1032,["type"]),s("span",Tt,n(o.name),1)]),o.properties?(c(),m("div",kt,[(c(!0),m(A,null,L(o.properties,(q,z)=>(c(),m("span",{key:z,class:"prop-item"},[s("strong",null,n(z)+":",1),p(" "+n(q),1)]))),128))])):P("",!0)],8,yt))),128))])]),_:1})):P("",!0),a(g,{class:"info-card"},{header:l(()=>[s("div",St,[a(r,null,{default:l(()=>[a(v(Be))]),_:1}),e[15]||(e[15]=s("span",null,"知识图谱结构说明",-1))])]),default:l(()=>[s("div",Ct,[e[16]||(e[16]=s("h4",null,"节点类型",-1)),(c(!0),m(A,null,L(te.value,o=>(c(),B(V,{key:o,class:"type-tag",type:K(o)>0?"primary":"info"},{default:l(()=>[p(n(W(o))+" ("+n(K(o))+") ",1)]),_:2},1032,["type"]))),128)),e[17]||(e[17]=s("h4",{style:{"margin-top":"20px"}},"关系类型",-1)),(c(!0),m(A,null,L(se.value,o=>(c(),B(V,{key:o,class:"type-tag",type:j(o)>0?"success":"info"},{default:l(()=>[p(n(pe(o))+" ("+n(j(o))+") ",1)]),_:2},1032,["type"]))),128))])]),_:1}),a(ge,{modelValue:h.value,"onUpdate:modelValue":e[2]||(e[2]=o=>h.value=o),title:"知识图谱构建进度",width:"600px","close-on-click-modal":!1,"show-close":!1},{footer:l(()=>[a(_,{onClick:ne},{default:l(()=>[...e[22]||(e[22]=[p("后台运行",-1)])]),_:1})]),default:l(()=>[s("div",wt,[a(R,{percentage:S.value,status:T.value==="failed"?"exception":void 0,"stroke-width":20},null,8,["percentage","status"]),s("div",bt,[a(r,{class:"step-icon"},{default:l(()=>[a(v(Z))]),_:1}),s("span",null,n(C.value),1)]),y.value>0?(c(),m("div",Pt,[s("div",Ot,[e[18]||(e[18]=s("span",{class:"label"},"总文档数：",-1)),s("span",xt,n(y.value),1)]),s("div",Dt,[e[19]||(e[19]=s("span",{class:"label"},"已处理：",-1)),s("span",It,n(w.value),1)]),b.value?(c(),m("div",Nt,[e[20]||(e[20]=s("span",{class:"label"},"当前文档：",-1)),s("span",Rt,n(b.value),1)])):P("",!0)])):P("",!0),a(fe,{title:"提示",type:"info",closable:!1,"show-icon":""},{default:l(()=>[...e[21]||(e[21]=[p(" 构建过程可能需要较长时间，请耐心等待。您可以关闭此对话框，任务将继续在后台执行。 ",-1)])]),_:1})])]),_:1},8,["modelValue"])])}}}),jt=me(Bt,[["__scopeId","data-v-a1ab2892"]]);export{jt as default};
