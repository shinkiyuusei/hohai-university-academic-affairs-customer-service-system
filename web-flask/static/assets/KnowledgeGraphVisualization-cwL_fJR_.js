import{_ as Ce}from"./_plugin-vue_export-helper-DRcqrMy4.js";/* empty css                   *//* empty css                   *//* empty css                        *//* empty css                   *//* empty css               *//* empty css                *//* empty css                 *//* empty css                 *//* empty css               *//* empty css                     *//* empty css                  */import{d as ke,r as m,s as Le,ad as $e,aZ as De,l as R,g as t,w as n,ab as Ie,a_ as Pe,n as L,o as S,f as N,c as F,x as O,an as Re,ao as Oe,h as xe,i as Ue,j as ze,k as Me,m as i,A as Fe,B as x,aK as Ve,z as $,aQ as Ae,a$ as Be,b0 as Ge,az as je,aA as qe,b1 as Qe,aU as ue,b2 as Ke,b3 as He,b4 as We,I as Je,av as Ye,b5 as Ze,b6 as Xe,y as et,aC as tt,aB as ot,O as nt,aa as lt}from"./index-CRHGP1uJ.js";import{i as de}from"./index-8VjjxCB0.js";import{e as at,f as st}from"./knowledge_graph-BZjO-zJj.js";const rt={class:"card-header"},it={class:"header-controls"},ut={class:"control-panel"},dt={style:{display:"flex","justify-content":"space-between","align-items":"center"}},ct={key:0,class:"node-detail"},gt={key:0,class:"node-properties"},ft={key:1,class:"node-connections"},mt={key:0},pt=ke({__name:"KnowledgeGraphVisualization",setup(vt){const U=m();let v=null;const j=m(),V=m(!1),A=m(""),B=m(!1),z=m({nodes:[],links:[]}),T=m({nodes:[],links:[]}),M=m({nodes:[],links:[]}),I=m(""),ce=m(!1),q=m(!1),Q=()=>{I.value="",q.value=!1},K=m(["AcademicPolicy","Course","Student","Teacher","Major","Schedule","Requirement","Procedure","Document","TimePoint"]),H=m(["APPLIES_TO","REQUIRES","BELONGS_TO","TAUGHT_BY","FOLLOWS","MEETS_REQUIREMENT","SCHEDULED_AT","RELATED_TO","DOCUMENTED_IN","PREREQUISITE_OF","EQUIVALENT_TO"]),W=m("force"),G=m(100),J=m(!1),_=m(null),Y=m({}),Z=m({}),X=m({}),oe={PlantDisease:"#ee6666",Plant:"#91cc75",Pathogen:"#fc8452",Symptom:"#fac858",Prevention:"#5470c6",Location:"#73c0de",Season:"#ea7ccc",Environment:"#3ba272",AcademicPolicy:"#ee6666",Course:"#91cc75",Student:"#fc8452",Teacher:"#fac858",Major:"#5470c6",Schedule:"#73c0de",Requirement:"#ea7ccc",Procedure:"#3ba272",Document:"#9a60b4",TimePoint:"#ca8622"},ne={PlantDisease:"植物病害",Plant:"植物",Pathogen:"病原体",Symptom:"症状",Prevention:"防治措施",Location:"地点",Season:"季节",Environment:"环境因素",Document:"文档",TimePoint:"时间点",AcademicPolicy:"教务政策",Course:"课程",Student:"学生",Teacher:"教师",Major:"专业",Schedule:"课表",Requirement:"要求规定",Procedure:"流程"},le={APPLIES_TO:"适用于",REQUIRES:"要求",BELONGS_TO:"属于专业",TAUGHT_BY:"由教师教授",FOLLOWS:"遵循流程",MEETS_REQUIREMENT:"满足要求",SCHEDULED_AT:"安排在时间",RELATED_TO:"相关于",DOCUMENTED_IN:"记录于文档",PREREQUISITE_OF:"是...的先修课",EQUIVALENT_TO:"等价于"},ge=a=>({PlantDisease:"danger",Plant:"success",Pathogen:"warning",Symptom:"warning",Prevention:"primary",Location:"info",Season:"danger",Environment:"success",Document:"info",TimePoint:"warning",AcademicPolicy:"danger",Course:"success",Student:"warning",Teacher:"warning",Major:"primary",Schedule:"info",Requirement:"danger",Procedure:"success"})[a]||"info",ee=a=>Y.value[a]||ne[a]||a,fe=a=>Z.value[a]||le[a]||a,ae=a=>X.value[a]||oe[a]||"#5470c6",me=async()=>{try{const a=await at();Y.value=a.nodeNames||{},Z.value=a.relationshipNames||{},X.value=a.nodeColors||{},A.value=a.neo4jBrowserUrl||""}catch(a){console.error("获取图谱配置失败:",a),Y.value=ne,Z.value=le,X.value=oe}},pe=()=>{A.value?(window.open(A.value,"_blank","noopener,noreferrer"),L.success("已在新标签页打开 Neo4j Browser")):L.warning("Neo4j Browser URL 未配置")},te=async()=>{B.value=!0;try{const a=await st({limit:G.value});console.log("=== 调试：后端返回的数据 ==="),console.log("节点数量:",a.nodes.length),console.log("关系数量:",a.relationships.length);const e=a.nodes.filter(l=>l.name&&l.name.includes("病害"));e.length>0&&(console.log("病害节点信息:"),e.forEach(l=>{console.log(`  - ${l.name}: id=${l.id}, degree=${l.degree}`)}));const d={nodes:a.nodes.map(l=>({id:l.id,name:l.name,category:l.type,value:l.degree||0,properties:l.properties||{}})),links:a.relationships.map(l=>({source:l.source,target:l.target,category:l.type,name:l.type}))};M.value=JSON.parse(JSON.stringify(d)),T.value=d,console.log("转换后的originalGraphData:",{nodesCount:T.value.nodes.length,linksCount:T.value.links.length,diseaseNodes:T.value.nodes.filter(l=>l.name&&l.name.includes("病害"))}),Q(),P();const g=new Set(d.nodes.map(l=>l.id)),f=d.links.filter(l=>!g.has(l.source)||!g.has(l.target));f.length>0&&(console.warn(`发现 ${f.length} 条孤立的边（端点节点不存在）:`),f.forEach(l=>{console.warn(`  - ${l.category} (${l.source} -> ${l.target})`)}));const p=d.links.filter(l=>l.source===l.target);p.length>0&&(console.info(`发现 ${p.length} 条自环边（节点指向自己）:`),p.forEach(l=>{const s=d.nodes.find(k=>k.id===l.source);console.info(`  - ${l.category}: ${s==null?void 0:s.name} -> ${s==null?void 0:s.name}`)}));const u=new Map;d.links.forEach(l=>{const s=`${l.source}-${l.target}`;u.set(s,(u.get(s)||0)+1)});const r=Array.from(u.entries()).filter(([l,s])=>s>1);r.length>0&&(console.info(`发现 ${r.length} 组重复边（相同source和target）:`),r.forEach(([l,s])=>{console.info(`  - ${l}: ${s} 条边`)})),P(),L.success(`图谱数据加载成功：${a.nodes.length} 个节点，${a.relationships.length} 条边`)}catch(a){L.error(`加载图谱数据失败: ${a.message}`)}finally{B.value=!1}},se=()=>{if(!I.value.trim()){L.warning("请输入搜索关键词");return}const a=I.value.trim().toLowerCase(),e=M.value.nodes.filter(u=>u.name&&u.name.toLowerCase().includes(a));if(e.length===0){L.info("未找到匹配的节点");return}const d=new Set(e.map(u=>u.id)),g=M.value.links.filter(u=>d.has(u.source)||d.has(u.target)),f=new Set;g.forEach(u=>{f.add(u.source),f.add(u.target)});const p=M.value.nodes.filter(u=>f.has(u.id));L.success(`找到 ${e.length} 个匹配节点，展示其 ${p.length} 个相关节点和 ${g.length} 条关系`),T.value={nodes:p,links:g},q.value=!0,P()},ve=()=>{Q(),T.value=JSON.parse(JSON.stringify(M.value)),P(),L.info("已恢复完整图谱视图")},_e=async()=>{Q(),await te()},P=()=>{console.log("=== filterNodes 开始 ==="),console.log("originalGraphData:",{nodes:T.value.nodes.length,links:T.value.links.length});const a=T.value.nodes.filter(r=>K.value.includes(r.category)).slice(0,G.value);console.log("过滤后的节点数:",a.length);const e=new Set;a.forEach(r=>{e.add(String(r.id))});const d=[],g=T.value.links.filter(r=>{const l=e.has(String(r.source)),s=e.has(String(r.target)),k=H.value.includes(r.category),o=l&&s&&k;return o||d.push({link:r,reason:l?s?"关系类型被过滤":"目标节点被过滤":"源节点被过滤"}),o});console.log("过滤后的边数:",g.length),console.log("被过滤掉的边数:",d.length),d.length>0&&d.length<=5&&(console.log("被过滤掉的边详情:"),d.forEach(r=>{console.log(`  - ${r.link.category} (${r.link.source} -> ${r.link.target}): ${r.reason}`)}));const f=new Map;g.forEach(r=>{const l=String(r.source),s=String(r.target);f.set(l,(f.get(l)||0)+1),f.set(s,(f.get(s)||0)+1)}),console.log("nodeDegreeMap 大小:",f.size);const p=a.filter(r=>r.name&&r.name.includes("病害"));p.length>0&&(console.log("病害节点度数计算:"),p.forEach(r=>{const l=String(r.id),s=f.get(l)||0;console.log(`  - ${r.name}: id=${r.id}, key=${l}, degree=${s}`)}));const u=a.map(r=>{const l=String(r.id),s=f.get(l)||0;return{...r,value:s}});z.value={nodes:u,links:g},re()},ye=()=>{P()},Ee=()=>{re()},he=()=>{v&&v.dispatchAction({type:"restore"})},be=()=>{if(j.value)if(V.value)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen();else{const a=j.value;a.requestFullscreen?a.requestFullscreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.msRequestFullscreen&&a.msRequestFullscreen()}},C=()=>{V.value=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement),setTimeout(()=>{v&&v.resize()},300)},re=()=>{if(!U.value)return;v&&v.dispose(),v=de(U.value);const a=z.value.nodes.map(o=>{const c=o.category||"Unknown",h=ee(c);return{...o,id:String(o.id),name:o.name,category:h,originalCategory:c,symbolSize:Math.max(10,Math.min(40,(o.value||1)*3)),itemStyle:{color:ae(c)}}}),e=new Map;a.forEach(o=>{e.set(o.id,o)});const d=new Set(a.map(o=>o.id));console.log("=== renderChart 边过滤 ==="),console.log("graphData.value.links 数量:",z.value.links.length),console.log("nodes 数量:",a.length),console.log("nodeIdSet 大小:",d.size);const g=[],f=z.value.links.filter(o=>{const c=String(o.source),h=String(o.target),b=d.has(c),w=d.has(h),y=b&&w;return y||g.push({link:o,reason:b?`目标节点${h}不存在`:`源节点${c}不存在`}),y}),p=new Map,u=new Map;f.forEach(o=>{const c=`${o.source}-${o.target}`;p.set(c,(p.get(c)||0)+1)});const r=f.map(o=>{const c=String(o.source),h=String(o.target),b=`${c}-${h}`,w=u.get(b)||0;u.set(b,w+1);const y=p.get(b)||1;let D=0;return y>1&&(D=.2+w*.2),{source:c,target:h,value:o.category,name:o.name||o.category,relationChinese:fe(o.category),isDuplicate:y>1,duplicateIndex:w+1,duplicateTotal:y,lineStyle:y>1?{curveness:D,color:"#999",width:1.5}:void 0}});console.log("renderChart 后的 links 数量:",r.length),console.log("renderChart 中被过滤掉的边数:",g.length),g.length>0&&(console.warn("renderChart 中被过滤掉的边:"),g.forEach(o=>{console.warn(`  - ${o.link.category} (${o.link.source} -> ${o.link.target}): ${o.reason}`)}));const s=["PlantDisease","Plant","Pathogen","Symptom","Prevention","Location","Season","Environment","Document","TimePoint"].map(o=>({name:ee(o),itemStyle:{color:ae(o)}})),k={title:{text:"植物病害知识图谱",subtext:`节点数: ${a.length}, 关系数: ${r.length}`,left:"center",textStyle:{fontSize:20,fontWeight:"bold"}},tooltip:{trigger:"item",formatter:o=>{if(o.dataType==="node")return`
            <div style="padding: 8px;">
              <b>${o.data.name}</b><br/>
              类型: ${o.data.category}<br/>
              连接数: ${o.data.value||0}
            </div>
          `;if(o.dataType==="edge"){const c=e.get(o.data.source),h=e.get(o.data.target),b=c?c.name:o.data.source,w=h?h.name:o.data.target,y=o.data.relationChinese||o.data.name;let D="";return o.data.isDuplicate&&(D=`<br/><span style="color: #f56c6c; font-size: 11px;">重复边 ${o.data.duplicateIndex}/${o.data.duplicateTotal}</span>`),`
            <div style="padding: 8px;">
              <b>${b}</b> → <b>${w}</b><br/>
              关系: ${y}${D}
            </div>
          `}return""}},legend:{data:s.map(o=>o.name),bottom:10,type:"scroll",orient:"horizontal"},series:[{type:"graph",layout:W.value,data:a,links:r,categories:s,roam:!0,draggable:!0,edgeSymbol:["none","arrow"],edgeSymbolSize:6,label:{show:!0,position:"right",formatter:"{b}",fontSize:11},edgeLabel:{show:!1,fontSize:10,formatter:o=>o.data.value||""},lineStyle:{color:"#ccc",width:1,opacity:.6,curveness:.1},emphasis:{focus:"adjacency",label:{fontSize:14,fontWeight:"bold"},lineStyle:{width:2.5,opacity:1,color:"#666"}},force:{repulsion:300,gravity:.15,edgeLength:120,layoutAnimation:!0}}]};v.setOption(k),v.resize(),v.on("click",o=>{o.dataType==="node"&&(_.value={...o.data,properties:o.data.properties||{},connections:z.value.links.filter(c=>c.source===o.data.id||c.target===o.data.id).map(c=>c.source===o.data.id?c.target:c.source)},J.value=!0)})},Se=()=>{U.value&&(v&&v.dispose(),v=de(U.value)),window.addEventListener("resize",()=>v==null?void 0:v.resize())};return Le(async()=>{await $e(),await me(),setTimeout(()=>{Se(),te()},50),document.addEventListener("fullscreenchange",C),document.addEventListener("webkitfullscreenchange",C),document.addEventListener("mozfullscreenchange",C),document.addEventListener("msfullscreenchange",C)}),De(()=>{document.removeEventListener("fullscreenchange",C),document.removeEventListener("webkitfullscreenchange",C),document.removeEventListener("mozfullscreenchange",C),document.removeEventListener("msfullscreenchange",C)}),(a,e)=>{const d=Fe,g=Me,f=Ue,p=xe,u=Oe,r=Re,l=Ae,s=Ge,k=Be,o=qe,c=je,h=Qe,b=Ie,w=et,y=Xe,D=Ze,ie=ot,Te=tt,we=Pe,Ne=Ye;return S(),R("div",{class:"kg-visualization",ref_key:"visualizationContainer",ref:j},[t(b,{class:"control-card"},{header:n(()=>[N("div",rt,[e[9]||(e[9]=N("span",null,"植物病害知识图谱可视化",-1)),N("div",it,[t(g,{type:"primary",onClick:te,loading:B.value},{default:n(()=>[t(d,null,{default:n(()=>[t(x(ue))]),_:1}),e[6]||(e[6]=i(" 刷新图谱 ",-1))]),_:1},8,["loading"]),t(g,{type:"info",onClick:he},{default:n(()=>[t(d,null,{default:n(()=>[t(x(ue))]),_:1}),e[7]||(e[7]=i(" 重置布局 ",-1))]),_:1}),A.value?(S(),F(g,{key:0,type:"warning",onClick:pe},{default:n(()=>[t(d,null,{default:n(()=>[t(x(Ke))]),_:1}),e[8]||(e[8]=i(" Neo4j Browser ",-1))]),_:1})):O("",!0),t(g,{type:"success",onClick:be},{default:n(()=>[t(d,null,{default:n(()=>[V.value?(S(),F(x(We),{key:1})):(S(),F(x(He),{key:0}))]),_:1}),i(" "+$(V.value?"退出全屏":"全屏"),1)]),_:1})])])]),default:n(()=>[N("div",ut,[t(r,{gutter:20},{default:n(()=>[t(u,{span:24},{default:n(()=>[t(p,{label:"搜索节点:"},{default:n(()=>[t(f,{modelValue:I.value,"onUpdate:modelValue":e[0]||(e[0]=E=>I.value=E),placeholder:"输入节点名称搜索，将展示该节点及其周围1层的关系",clearable:"",onKeyup:ze(se,["enter"]),style:{width:"100%"}},{append:n(()=>[t(g,{onClick:se,loading:ce.value},{default:n(()=>[t(d,null,{default:n(()=>[t(x(Ve))]),_:1}),e[10]||(e[10]=i(" 搜索 ",-1))]),_:1},8,["loading"])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),q.value?(S(),F(l,{key:0,title:"当前为搜索模式",type:"info",closable:!1,"show-icon":"",style:{"margin-bottom":"15px"}},{default:n(()=>[N("div",dt,[N("span",null,'正在展示关键词"'+$(I.value)+'"的搜索结果及其邻居节点',1),t(g,{size:"small",onClick:ve},{default:n(()=>[...e[11]||(e[11]=[i("清除搜索，恢复完整图谱",-1)])]),_:1})])]),_:1})):O("",!0),t(r,{gutter:20},{default:n(()=>[t(u,{span:12},{default:n(()=>[t(p,{label:"节点类型过滤:"},{default:n(()=>[t(k,{modelValue:K.value,"onUpdate:modelValue":e[1]||(e[1]=E=>K.value=E),onChange:P},{default:n(()=>[t(s,{label:"AcademicPolicy"},{default:n(()=>[...e[12]||(e[12]=[i("教务政策",-1)])]),_:1}),t(s,{label:"Course"},{default:n(()=>[...e[13]||(e[13]=[i("课程",-1)])]),_:1}),t(s,{label:"Student"},{default:n(()=>[...e[14]||(e[14]=[i("学生",-1)])]),_:1}),t(s,{label:"Teacher"},{default:n(()=>[...e[15]||(e[15]=[i("教师",-1)])]),_:1}),t(s,{label:"Major"},{default:n(()=>[...e[16]||(e[16]=[i("专业",-1)])]),_:1}),t(s,{label:"Schedule"},{default:n(()=>[...e[17]||(e[17]=[i("课表",-1)])]),_:1}),t(s,{label:"Requirement"},{default:n(()=>[...e[18]||(e[18]=[i("要求规定",-1)])]),_:1}),t(s,{label:"Procedure"},{default:n(()=>[...e[19]||(e[19]=[i("流程",-1)])]),_:1}),t(s,{label:"Document"},{default:n(()=>[...e[20]||(e[20]=[i("文档",-1)])]),_:1}),t(s,{label:"TimePoint"},{default:n(()=>[...e[21]||(e[21]=[i("时间点",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(u,{span:12},{default:n(()=>[t(p,{label:"关系类型过滤:"},{default:n(()=>[t(k,{modelValue:H.value,"onUpdate:modelValue":e[2]||(e[2]=E=>H.value=E),onChange:ye},{default:n(()=>[t(s,{label:"APPLIES_TO"},{default:n(()=>[...e[22]||(e[22]=[i("适用于",-1)])]),_:1}),t(s,{label:"REQUIRES"},{default:n(()=>[...e[23]||(e[23]=[i("要求",-1)])]),_:1}),t(s,{label:"BELONGS_TO"},{default:n(()=>[...e[24]||(e[24]=[i("属于专业",-1)])]),_:1}),t(s,{label:"TAUGHT_BY"},{default:n(()=>[...e[25]||(e[25]=[i("由教师教授",-1)])]),_:1}),t(s,{label:"FOLLOWS"},{default:n(()=>[...e[26]||(e[26]=[i("遵循流程",-1)])]),_:1}),t(s,{label:"MEETS_REQUIREMENT"},{default:n(()=>[...e[27]||(e[27]=[i("满足要求",-1)])]),_:1}),t(s,{label:"SCHEDULED_AT"},{default:n(()=>[...e[28]||(e[28]=[i("安排在时间",-1)])]),_:1}),t(s,{label:"RELATED_TO"},{default:n(()=>[...e[29]||(e[29]=[i("相关于",-1)])]),_:1}),t(s,{label:"DOCUMENTED_IN"},{default:n(()=>[...e[30]||(e[30]=[i("记录于文档",-1)])]),_:1}),t(s,{label:"PREREQUISITE_OF"},{default:n(()=>[...e[31]||(e[31]=[i("是...的先修课",-1)])]),_:1}),t(s,{label:"EQUIVALENT_TO"},{default:n(()=>[...e[32]||(e[32]=[i("等价于",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(r,{gutter:20},{default:n(()=>[t(u,{span:12},{default:n(()=>[t(p,{label:"布局设置:"},{default:n(()=>[t(c,{modelValue:W.value,"onUpdate:modelValue":e[3]||(e[3]=E=>W.value=E),onChange:Ee,style:{width:"100%"}},{default:n(()=>[t(o,{label:"力导向布局",value:"force"}),t(o,{label:"环形布局",value:"circular"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(u,{span:12},{default:n(()=>[t(p,{label:"显示数量限制:"},{default:n(()=>[t(h,{modelValue:G.value,"onUpdate:modelValue":e[4]||(e[4]=E=>G.value=E),min:10,max:500,onChange:_e,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})])]),_:1}),t(b,{class:"chart-card"},{default:n(()=>[Je(N("div",{ref_key:"chartContainer",ref:U,class:"chart-container","element-loading-text":"加载图谱数据中..."},null,512),[[Ne,B.value]])]),_:1}),t(we,{modelValue:J.value,"onUpdate:modelValue":e[5]||(e[5]=E=>J.value=E),title:"节点详情",direction:"rtl",size:"400px"},{default:n(()=>[_.value?(S(),R("div",ct,[t(D,{column:1,border:""},{default:n(()=>[t(y,{label:"节点类型"},{default:n(()=>[t(w,{type:ge(_.value.originalCategory)},{default:n(()=>[i($(ee(_.value.originalCategory)),1)]),_:1},8,["type"])]),_:1}),t(y,{label:"节点名称"},{default:n(()=>[i($(_.value.name),1)]),_:1}),t(y,{label:"节点ID"},{default:n(()=>[i($(_.value.id),1)]),_:1}),t(y,{label:"连接数"},{default:n(()=>[i($(_.value.value||0),1)]),_:1})]),_:1}),_.value.properties&&Object.keys(_.value.properties).length>0?(S(),R("div",gt,[e[33]||(e[33]=N("h4",null,"节点属性",-1)),t(Te,{data:Object.entries(_.value.properties),size:"small",border:""},{default:n(()=>[t(ie,{prop:"0",label:"属性名",width:"120"}),t(ie,{prop:"1",label:"属性值"})]),_:1},8,["data"])])):O("",!0),_.value.connections&&_.value.connections.length>0?(S(),R("div",ft,[e[34]||(e[34]=N("h4",null,"相关连接",-1)),(S(!0),R(nt,null,lt(_.value.connections.slice(0,10),E=>(S(),F(w,{key:E,style:{margin:"2px"},size:"small"},{default:n(()=>[i($(E),1)]),_:2},1024))),128)),_.value.connections.length>10?(S(),R("span",mt," 等"+$(_.value.connections.length-10)+"个连接... ",1)):O("",!0)])):O("",!0)])):O("",!0)]),_:1},8,["modelValue"])],512)}}}),Pt=Ce(pt,[["__scopeId","data-v-50162a79"]]);export{Pt as default};
