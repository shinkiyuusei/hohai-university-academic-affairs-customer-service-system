import{_ as Ce}from"./_plugin-vue_export-helper-DRcqrMy4.js";/* empty css                  *//* empty css                   *//* empty css                *//* empty css                 *//* empty css               *//* empty css                  *//* empty css                  */import{p as C,d as xe,u as Te,q as te,r as f,s as be,l as v,f as t,g as a,I as se,J as ae,B as r,a5 as Le,k as Me,a6 as qe,a7 as Re,x as h,O as D,a8 as O,w as l,A as $e,v as Q,a9 as Ue,aa as ze,n as p,ab as Ee,o as u,M as K,P as F,Z as De,ac as J,i as Ie,j as Be,ad as G,ae as Ve,m as g,z as k,af as ne,ag as oe,ah as Se,ai as Oe,aj as je,ak as Ae,c as W,y as Ne,Q as le,N as He}from"./index-CK_LbvG7.js";import{d as Pe}from"./marked.esm-CbTws8Ir.js";import{l as ie}from"./logo-COisWnUJ.js";import"./file_request-t1Lt81_s.js";function Qe(c,q){if(q){const w=new FormData;return w.append("question",c.question),w.append("conversation_id",String(c.conversation_id)),c.top_k&&w.append("top_k",String(c.top_k)),c.history&&w.append("history",JSON.stringify(c.history)),w.append("image",q),C.post("/api/qa/ask",w,{headers:{"Content-Type":"multipart/form-data"}})}else return C.post("/api/qa/ask",c)}function Ke(){return C.get("/api/qa/conversation/list")}function Fe(c){return C.post("/api/qa/conversation/create",{title:c})}function Je(c){return C.delete(`/api/qa/conversation/${c}`)}function Ge(c,q){return C.put(`/api/qa/conversation/${c}/rename`,{title:q})}function We(c){return C.get(`/api/qa/conversation/${c}/messages`)}function Ze(c){return C.delete(`/api/qa/conversation/${c}/messages`)}function Xe(c){return C.post(`/api/qa/conversation/${c}/generate-title`)}const Ye={class:"qa-chat-container"},et={class:"sidebar-header"},tt={class:"sidebar-title"},st={class:"header-actions"},at={class:"conversation-list"},nt=["onClick"],ot={class:"conversation-info"},lt={class:"conversation-title"},it={class:"conversation-time"},rt={class:"conversation-actions"},ut={key:0,class:"empty-conversations"},ct={class:"chat-main"},dt={class:"card-header"},vt={class:"card-title"},pt={key:0,class:"header-buttons"},_t={class:"chat-area"},mt={key:0,class:"welcome-message"},ft={class:"example-questions"},gt={class:"message-avatar"},yt={class:"message-content"},ht={key:0,class:"message-image"},kt=["innerHTML"],wt={key:1,class:"keywords-section"},Ct={class:"tag-list"},xt={key:2,class:"related-entities"},Tt={class:"entity-tags"},bt={key:3,class:"graph-context"},Lt={class:"context-content"},Mt={class:"message-content"},qt={key:0,class:"message-image"},Rt=["innerHTML"],$t={class:"message-avatar"},Ut={key:0,class:"message-item assistant loading"},zt={class:"message-avatar"},Et={class:"input-area"},Dt={key:0,class:"image-preview-container"},It={class:"image-preview"},Bt=["src"],Vt={class:"input-actions"},St={class:"left-actions"},Ot={class:"right-actions"},jt={class:"input-tip"},At=xe({__name:"QAChat",setup(c){const q=Te(),w=te(()=>{var s;return((s=q.userInfo)==null?void 0:s.avatarUrl)||""}),R=f(""),_=f([]),x=f(!1),V=f(),S=f(null),y=f(""),$=f(),T=f([]),d=f(null),I=f(!1),B=f(""),j=f(null),U=f(!1),re=()=>{U.value=!U.value},ue=te(()=>{if(!T.value)return"教务智能问答";const s=T.value.find(e=>e.id===d.value);return s?s.title:"教务智能问答"}),ce=s=>({Typhoon:"danger",Location:"warning",DisasterType:"danger",Damage:"danger",PreventiveMeasure:"success",RescueAction:"primary",Organization:"info",Document:"",TimePoint:"warning"})[s]||"",de=s=>{const e=new Date(s),i=new Date().getTime()-e.getTime();return i<6e4?"刚刚":i<36e5?`${Math.floor(i/6e4)}分钟前`:i<864e5?`${Math.floor(i/36e5)}小时前`:e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},Z=s=>Pe(s,{breaks:!0}),A=()=>{Ee(()=>{V.value&&(V.value.scrollTop=V.value.scrollHeight)})},z=async()=>{try{const s=await Ke();T.value=s.list,T.value.length>0&&!d.value&&await X(T.value[0].id)}catch(s){p.error(s.message||"加载会话列表失败")}},ve=async()=>{try{const s=await Fe();d.value=s.conversation_id,_.value=[],await z(),p.success("创建会话成功")}catch(s){p.error(s.message||"创建会话失败")}},X=async s=>{if(d.value!==s){d.value=s,_.value=[];try{(await We(s)).list.forEach(o=>{_.value.push({type:"user",content:o.question,image_url:o.image_url}),_.value.push({type:"assistant",content:o.answer,related_entities:o.related_entities,graph_context:o.graph_context,keywords:o.keywords||[]})}),A()}catch(e){p.error(e.message||"加载会话消息失败")}}},pe=async s=>{try{await oe.confirm("确定要删除这个会话吗?删除后将无法恢复!","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Je(s),d.value===s&&(d.value=null,_.value=[]),await z(),p.success("删除会话成功")}catch(e){e!=="cancel"&&p.error(e.message||"删除会话失败")}},_e=s=>{j.value=s.id,B.value=s.title,I.value=!0},me=async()=>{if(!B.value.trim()){p.warning("会话名称不能为空");return}if(j.value)try{await Ge(j.value,B.value),await z(),I.value=!1,p.success("重命名成功")}catch(s){p.error(s.message||"重命名失败")}},fe=async()=>{if(d.value)try{const s=p({message:"正在生成标题...",type:"info",duration:0}),e=await Xe(d.value);s.close(),await z(),p.success(`标题生成成功: ${e.title}`)}catch(s){p.error(s.message||"生成标题失败")}},ge=async()=>{if(d.value)try{await oe.confirm("确定要清除当前会话的所有消息记录吗?清除后将无法恢复!","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Ze(d.value),_.value=[],p.success("清除成功")}catch(s){s!=="cancel"&&p.error(s.message||"清除失败")}},N=s=>{R.value=s,H()},ye=s=>{var i;const e=s.target,o=(i=e.files)==null?void 0:i[0];if(!o){console.log("[图片上传] 未选择文件");return}if(console.log("[图片上传] 选择了文件:",o.name,o.type,o.size),!o.type.startsWith("image/")){p.error("请上传图片文件"),e.value="";return}if(o.size>10*1024*1024){p.error("图片大小不能超过10MB"),e.value="";return}y.value&&URL.revokeObjectURL(y.value),S.value=o,y.value=URL.createObjectURL(o),console.log("[图片上传] 预览URL生成:",y.value),e.value=""},he=()=>{console.log("[图片上传] 移除图片"),y.value&&URL.revokeObjectURL(y.value),S.value=null,y.value="",$.value&&($.value.value="")},H=async()=>{const s=R.value.trim();if(!s||x.value||!d.value)return;const e=S.value,o=y.value,i=_.value.length;_.value.push({type:"user",content:s,image_url:o||void 0}),R.value="",S.value=null,y.value="",$.value&&($.value.value=""),A(),x.value=!0;try{const L=_.value.slice(0,-1).slice(-6).map(E=>({role:E.type==="user"?"user":"assistant",content:E.content})),m=await Qe({question:s,conversation_id:d.value,top_k:7,history:L},e||void 0);m.image_url&&(o&&URL.revokeObjectURL(o),_.value[i].image_url=m.image_url),_.value.push({type:"assistant",content:m.answer,related_entities:m.related_entities||[],graph_context:m.graph_context,diseaseInfoMatches:m.disease_info_matches||[],diseaseCaseMatches:m.disease_case_matches||[],diseaseInfoContext:m.disease_info_context||"",diseaseCaseContext:m.disease_case_context||"",keywords:m.keywords||[]}),A(),await z()}catch(L){p.error(L.message||"提问失败,请重试"),_.value.pop(),o&&URL.revokeObjectURL(o)}finally{x.value=!1}};return be(()=>{z()}),(s,e)=>{const o=Me,i=$e,L=De,m=Oe,E=je,Y=Ne,ee=Ie,ke=Ue,we=ze;return u(),v("div",Ye,[t("div",{class:Q(["conversation-sidebar",{collapsed:U.value}])},[t("div",et,[se(t("span",tt,"会话列表",512),[[ae,!U.value]]),t("div",st,[se(a(o,{type:"primary",icon:r(Le),size:"small",onClick:ve,circle:"",title:"新建会话"},null,8,["icon"]),[[ae,!U.value]]),a(o,{icon:U.value?r(qe):r(Re),size:"small",onClick:re,circle:"",title:"折叠/展开"},null,8,["icon"])])]),t("div",at,[(u(!0),v(D,null,O(T.value,n=>(u(),v("div",{key:n.id,class:Q(["conversation-item",{active:d.value===n.id}]),onClick:M=>X(n.id)},[t("div",ot,[t("div",lt,k(n.title),1),t("div",it,k(de(n.update_time)),1)]),t("div",rt,[a(i,{onClick:G(M=>_e(n),["stop"]),class:"action-icon"},{default:l(()=>[a(r(Se))]),_:1},8,["onClick"]),a(i,{onClick:G(M=>pe(n.id),["stop"]),class:"action-icon"},{default:l(()=>[a(r(J))]),_:1},8,["onClick"])])],10,nt))),128)),!T.value||T.value.length===0?(u(),v("div",ut,[a(i,null,{default:l(()=>[a(r(K))]),_:1}),e[8]||(e[8]=t("p",null,"暂无会话,点击右上角创建新会话",-1))])):h("",!0)])],2),t("div",ct,[a(ke,{class:"chat-card"},{header:l(()=>[t("div",dt,[t("span",vt,[a(i,null,{default:l(()=>[a(r(K))]),_:1}),g(" "+k(ue.value),1)]),d.value&&_.value.length>0?(u(),v("div",pt,[a(o,{type:"primary",icon:r(ne),size:"small",onClick:fe},{default:l(()=>[...e[9]||(e[9]=[g(" 生成标题 ",-1)])]),_:1},8,["icon"]),a(o,{type:"danger",icon:r(J),size:"small",onClick:ge,plain:""},{default:l(()=>[...e[10]||(e[10]=[g(" 清除记录 ",-1)])]),_:1},8,["icon"])])):h("",!0)])]),default:l(()=>[t("div",_t,[_.value.length===0?(u(),v("div",mt,[a(i,{class:"welcome-icon"},{default:l(()=>[a(r(K))]),_:1}),e[15]||(e[15]=t("h3",null,"欢迎使用河海大学校务智能问答系统",-1)),e[16]||(e[16]=t("p",null,"我可以基于校务知识图谱回答您的问题",-1)),t("div",ft,[e[14]||(e[14]=t("p",{class:"example-title"},"您可以问我:",-1)),t("div",{class:"example-question",onClick:e[0]||(e[0]=n=>N("高数一教学安排有哪些?"))},[a(i,null,{default:l(()=>[a(r(F))]),_:1}),e[11]||(e[11]=t("span",null,"高数一教学安排有哪些?",-1))]),t("div",{class:"example-question",onClick:e[1]||(e[1]=n=>N("校务处具体电话是多少?"))},[a(i,null,{default:l(()=>[a(r(F))]),_:1}),e[12]||(e[12]=t("span",null,"校务处具体电话是多少?",-1))]),t("div",{class:"example-question",onClick:e[2]||(e[2]=n=>N("选修课选课时间具体是什么时候?"))},[a(i,null,{default:l(()=>[a(r(F))]),_:1}),e[13]||(e[13]=t("span",null,"选修课选课时间具体是什么时候?",-1))])])])):h("",!0),t("div",{class:"message-list",ref_key:"messageListRef",ref:V},[(u(!0),v(D,null,O(_.value,(n,M)=>(u(),v("div",{key:M,class:Q(["message-item",n.type])},[n.type==="assistant"?(u(),v(D,{key:0},[t("div",gt,[a(L,{size:32,src:r(ie),style:{"background-color":"#fff"}},null,8,["src"])]),t("div",yt,[n.image_url?(u(),v("div",ht,[a(m,{src:n.image_url,fit:"contain",style:{"max-width":"300px","max-height":"300px","border-radius":"8px"},"preview-src-list":[n.image_url],"preview-teleported":""},null,8,["src","preview-src-list"])])):h("",!0),t("div",{class:"message-text",innerHTML:Z(n.content)},null,8,kt),n.keywords&&n.keywords.length?(u(),v("div",wt,[a(E,{"content-position":"left"},{default:l(()=>[a(i,null,{default:l(()=>[a(r(Ae))]),_:1}),e[17]||(e[17]=g(" 关键词 ",-1))]),_:1}),t("div",Ct,[(u(!0),v(D,null,O(n.keywords,(b,P)=>(u(),W(Y,{key:`${b}-${P}`,size:"small",effect:"plain"},{default:l(()=>[g(k(b),1)]),_:2},1024))),128))])])):h("",!0),n.related_entities&&n.related_entities.length>0?(u(),v("div",xt,[a(E,{"content-position":"left"},{default:l(()=>[a(i,null,{default:l(()=>[a(r(le))]),_:1}),g(" 相关知识图谱实体 ("+k(n.related_entities.length)+") ",1)]),_:2},1024),t("div",Tt,[(u(!0),v(D,null,O(n.related_entities.slice(0,10),(b,P)=>(u(),W(Y,{key:P,type:ce(b.type),size:"default",class:"entity-tag",title:`${b.type}: ${b.name}`},{default:l(()=>[t("strong",null,k(b.type)+":",1),g(" "+k(b.name),1)]),_:2},1032,["type","title"]))),128))])])):h("",!0),n.graph_context?(u(),v("div",bt,[a(E,{"content-position":"left"},{default:l(()=>[a(i,null,{default:l(()=>[a(r(le))]),_:1}),e[18]||(e[18]=g(" 知识图谱关联关系 ",-1))]),_:1}),t("div",Lt,[t("pre",null,k(n.graph_context),1)])])):h("",!0)])],64)):(u(),v(D,{key:1},[t("div",Mt,[n.image_url?(u(),v("div",qt,[a(m,{src:n.image_url,fit:"contain",style:{"max-width":"300px","max-height":"300px","border-radius":"8px"},"preview-src-list":[n.image_url],"preview-teleported":""},null,8,["src","preview-src-list"])])):h("",!0),t("div",{class:"message-text",innerHTML:Z(n.content)},null,8,Rt)]),t("div",$t,[a(L,{size:32,src:w.value},{default:l(()=>[w.value?h("",!0):(u(),W(i,{key:0},{default:l(()=>[a(r(He))]),_:1}))]),_:1},8,["src"])])],64))],2))),128)),x.value?(u(),v("div",Ut,[t("div",zt,[a(L,{size:32,src:r(ie),style:{"background-color":"#fff"}},null,8,["src"])]),e[19]||(e[19]=t("div",{class:"message-content"},[t("div",{class:"typing-indicator"},[t("span"),t("span"),t("span")])],-1))])):h("",!0)],512)]),t("div",Et,[y.value?(u(),v("div",Dt,[t("div",It,[t("img",{src:y.value,alt:"上传的图片"},null,8,Bt),a(i,{class:"remove-image",onClick:he},{default:l(()=>[a(r(J))]),_:1})])])):h("",!0),a(ee,{modelValue:R.value,"onUpdate:modelValue":e[3]||(e[3]=n=>R.value=n),type:"textarea",rows:3,placeholder:"请输入您的问题...",disabled:x.value||!d.value,onKeydown:Be(G(H,["ctrl"]),["enter"])},null,8,["modelValue","disabled","onKeydown"]),t("div",Vt,[t("div",St,[t("input",{type:"file",ref_key:"imageInputRef",ref:$,accept:"image/*",style:{display:"none"},onChange:ye},null,544),a(o,{icon:r(Ve),size:"small",disabled:x.value||!d.value,onClick:e[4]||(e[4]=n=>{var M;return(M=$.value)==null?void 0:M.click()}),title:"上传图片"},{default:l(()=>[...e[20]||(e[20]=[g(" 上传图片 ",-1)])]),_:1},8,["icon","disabled"])]),t("div",Ot,[t("span",jt,k(d.value?"按 Ctrl+Enter 发送":"请先创建或选择会话"),1),a(o,{type:"success",icon:r(ne),loading:x.value,disabled:!R.value.trim()||!d.value,onClick:H},{default:l(()=>[g(k(x.value?"思考中...":"发送问题"),1)]),_:1},8,["icon","loading","disabled"])])])])]),_:1})]),a(we,{modelValue:I.value,"onUpdate:modelValue":e[7]||(e[7]=n=>I.value=n),title:"重命名会话",width:"400px","close-on-click-modal":!1},{footer:l(()=>[a(o,{onClick:e[6]||(e[6]=n=>I.value=!1)},{default:l(()=>[...e[21]||(e[21]=[g("取消",-1)])]),_:1}),a(o,{type:"primary",onClick:me},{default:l(()=>[...e[22]||(e[22]=[g("确定",-1)])]),_:1})]),default:l(()=>[a(ee,{modelValue:B.value,"onUpdate:modelValue":e[5]||(e[5]=n=>B.value=n),placeholder:"请输入新的会话名称",maxlength:"50","show-word-limit":""},null,8,["modelValue"])]),_:1},8,["modelValue"])])}}}),es=Ce(At,[["__scopeId","data-v-d472fb0d"]]);export{es as default};
